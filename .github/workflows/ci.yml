name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Lint, Type Check & Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run ESLint
        id: eslint
        run: bun run lint 2>&1 | tee eslint-output.txt
        continue-on-error: true

      - name: TypeScript type check
        id: typescript
        run: bun run tsc --noEmit 2>&1 | tee typescript-output.txt
        continue-on-error: true

      - name: Build project
        id: build
        run: bun run build 2>&1 | tee build-output.txt
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const eslintResult = '${{ steps.eslint.outcome }}';
            const typescriptResult = '${{ steps.typescript.outcome }}';
            const buildResult = '${{ steps.build.outcome }}';

            // Read outputs
            let eslintOutput = '';
            let typescriptOutput = '';
            let buildOutput = '';

            try { eslintOutput = fs.readFileSync('eslint-output.txt', 'utf8'); } catch (e) {}
            try { typescriptOutput = fs.readFileSync('typescript-output.txt', 'utf8'); } catch (e) {}
            try { buildOutput = fs.readFileSync('build-output.txt', 'utf8'); } catch (e) {}

            // Truncate long outputs
            const truncate = (str, max = 3000) => str.length > max ? str.slice(0, max) + '\n... (truncated)' : str;

            const icon = (result) => result === 'success' ? '✅' : '❌';

            let body = `## CI Results\n\n`;
            body += `| Check | Status |\n`;
            body += `|-------|--------|\n`;
            body += `| ESLint | ${icon(eslintResult)} ${eslintResult} |\n`;
            body += `| TypeScript | ${icon(typescriptResult)} ${typescriptResult} |\n`;
            body += `| Build | ${icon(buildResult)} ${buildResult} |\n\n`;

            if (eslintResult === 'failure' && eslintOutput) {
              body += `### ESLint Errors\n\`\`\`\n${truncate(eslintOutput)}\n\`\`\`\n\n`;
            }

            if (typescriptResult === 'failure' && typescriptOutput) {
              body += `### TypeScript Errors\n\`\`\`\n${truncate(typescriptOutput)}\n\`\`\`\n\n`;
            }

            if (buildResult === 'failure' && buildOutput) {
              body += `### Build Errors\n\`\`\`\n${truncate(buildOutput)}\n\`\`\`\n\n`;
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('## CI Results'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if any step failed
        if: steps.eslint.outcome == 'failure' || steps.typescript.outcome == 'failure' || steps.build.outcome == 'failure'
        run: exit 1
